# Builderï¼ˆå›¾æ„å»ºå™¨ï¼‰é€»è¾‘åˆ†æ

## ä¸€ã€æ¦‚è¿°

`builder.go` æ˜¯æ•´ä¸ª **deer-go å¤šæ™ºèƒ½ä½“ç³»ç»Ÿçš„æ¶æ„æ ¸å¿ƒ**ï¼Œè´Ÿè´£æ„å»ºã€è¿æ¥å’Œç¼–è¯‘æ‰€æœ‰å­å›¾ï¼ˆAgentï¼‰ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„åŠ¨æ€è·¯ç”±å›¾ã€‚å®ƒæ˜¯ç³»ç»Ÿçš„"æ€»è£…é…çº¿"ï¼Œå°†æ‰€æœ‰ç‹¬ç«‹çš„æ™ºèƒ½ä½“ç»„è£…æˆä¸€ä¸ªååŒå·¥ä½œçš„æ•´ä½“ã€‚

### æ ¸å¿ƒèŒè´£

1. **åˆå§‹åŒ–æ‰€æœ‰å­å›¾**ï¼šåˆ›å»º 8 ä¸ªä¸“ä¸šåŒ–çš„ Agent å­å›¾
2. **å»ºç«‹åŠ¨æ€è·¯ç”±**ï¼šé€šè¿‡ `agentHandOff` å®ç°çŠ¶æ€é©±åŠ¨çš„æµç¨‹æ§åˆ¶
3. **ç¼–è¯‘å¯æ‰§è¡Œå›¾**ï¼šå°†å›¾ç»“æ„ç¼–è¯‘ä¸ºå¯è¿è¡Œçš„ `Runnable`
4. **é…ç½®å…¨å±€çŠ¶æ€**ï¼šè®¾ç½®å…±äº«çŠ¶æ€ç®¡ç†å’Œæ£€æŸ¥ç‚¹æœºåˆ¶

---

## äºŒã€æ ¸å¿ƒç»„ä»¶åˆ†æ

### 2.1 `agentHandOff` å‡½æ•°ï¼ˆ34-43è¡Œï¼‰

**ä½œç”¨**ï¼šå…¨å±€è·¯ç”±å‡½æ•°ï¼Œè¯»å– `state.Goto` å¹¶å†³å®šä¸‹ä¸€ä¸ªæ‰§è¡Œçš„ Agent

#### å®ç°é€»è¾‘

```go
func agentHandOff(ctx context.Context, input string) (next string, err error) {
    defer func() {
        ilog.EventInfo(ctx, "agent_hand_off", "input", input, "next", next)
    }()
    
    _ = compose.ProcessState[*model.State](ctx, func(_ context.Context, state *model.State) error {
        next = state.Goto  // ğŸ‘ˆ å…³é”®ï¼šä»å…±äº«çŠ¶æ€è¯»å–ä¸‹ä¸€æ­¥
        return nil
    })
    
    return next, nil
}
```

#### å…³é”®ç‰¹æ€§

- **çŠ¶æ€é©±åŠ¨**ï¼šè·¯ç”±å†³ç­–å®Œå…¨ç”± `state.Goto` æ§åˆ¶
- **æ— æ¡ä»¶é€»è¾‘**ï¼šæœ¬èº«ä¸åŒ…å«åˆ¤æ–­é€»è¾‘ï¼Œåªè´Ÿè´£è¯»å–å’Œä¼ é€’
- **å…¨å±€ç»Ÿä¸€**ï¼šæ‰€æœ‰ Agent çš„è·¯ç”±éƒ½é€šè¿‡è¿™ä¸ªå‡½æ•°
- **æ—¥å¿—è¿½è¸ª**ï¼šè®°å½•æ¯æ¬¡è·¯ç”±çš„æºå’Œç›®æ ‡ï¼Œä¾¿äºè°ƒè¯•

#### å·¥ä½œåŸç†

```
ä¸Šä¸€ä¸ª Agent æ‰§è¡Œ:
  â””â”€ router èŠ‚ç‚¹è®¾ç½®: state.Goto = "planner"

agentHandOff è°ƒç”¨:
  â””â”€ è¯»å–: next = state.Goto  // "planner"
  â””â”€ è¿”å›: "planner"

Graph å¼•æ“:
  â””â”€ æ ¹æ®è¿”å›å€¼è·¯ç”±åˆ° Planner å­å›¾
```

---

### 2.2 `Builder` å‡½æ•°ï¼ˆ46-119è¡Œï¼‰

**ä½œç”¨**ï¼šç³»ç»Ÿçš„æ€»æ„å»ºå‡½æ•°ï¼Œç»„è£…æ‰€æœ‰å­å›¾å¹¶ç¼–è¯‘æˆå¯æ‰§è¡Œçš„ Runnable

#### å‡½æ•°ç­¾å

```go
func Builder[I, O, S any](ctx context.Context, genFunc compose.GenLocalState[S]) compose.Runnable[I, O]
```

**æ³›å‹å‚æ•°**ï¼š
- `I`ï¼šå›¾çš„è¾“å…¥ç±»å‹
- `O`ï¼šå›¾çš„è¾“å‡ºç±»å‹
- `S`ï¼šå…±äº«çŠ¶æ€ç±»å‹ï¼ˆ`*model.State`ï¼‰

#### æ ¸å¿ƒæ­¥éª¤

##### æ­¥éª¤1ï¼šåˆ›å»ºä¸»å›¾ï¼ˆ62-64è¡Œï¼‰

```go
g := compose.NewGraph[I, O](
    compose.WithGenLocalState(genFunc),  // ğŸ‘ˆ å…³é”®ï¼šæ³¨å…¥çŠ¶æ€åˆå§‹åŒ–å‡½æ•°
)
```

**`genFunc` çš„ä½œç”¨**ï¼š
- ä¸ºæ¯æ¬¡å›¾æ‰§è¡Œåˆ›å»ºç‹¬ç«‹çš„ `State` å®ä¾‹
- ç¡®ä¿å¹¶å‘æ‰§è¡Œæ—¶çŠ¶æ€éš”ç¦»
- æ”¯æŒä» CheckPoint æ¢å¤çŠ¶æ€

##### æ­¥éª¤2ï¼šå®šä¹‰è·¯ç”±æ˜ å°„ï¼ˆ66-76è¡Œï¼‰

```go
outMap := map[string]bool{
    consts.Coordinator:            true,
    consts.Planner:                true,
    consts.Reporter:               true,
    consts.ResearchTeam:           true,
    consts.Researcher:             true,
    consts.Coder:                  true,
    consts.BackgroundInvestigator: true,
    consts.Human:                  true,
    compose.END:                   true,
}
```

**ç”¨é€”**ï¼š
- å®šä¹‰æ‰€æœ‰å¯èƒ½çš„è·¯ç”±ç›®æ ‡
- ç”¨äº `AddBranch` çš„åˆæ³•æ€§æ ¡éªŒ
- ç¡®ä¿ `agentHandOff` è¿”å›çš„èŠ‚ç‚¹åæ˜¯æœ‰æ•ˆçš„

##### æ­¥éª¤3ï¼šåˆå§‹åŒ–æ‰€æœ‰å­å›¾ï¼ˆ79-86è¡Œï¼‰

```go
coordinatorGraph := NewCAgent[I, O](ctx)
plannerGraph := NewPlanner[I, O](ctx)
reporterGraph := NewReporter[I, O](ctx)
researchTeamGraph := NewResearchTeamNode[I, O](ctx)
researcherGraph := NewResearcher[I, O](ctx)
bIGraph := NewBAgent[I, O](ctx)
coder := NewCoder[I, O](ctx)
human := NewHumanNode[I, O](ctx)
```

**8 ä¸ªä¸“ä¸šåŒ– Agent**ï¼š

| Agent | èŒè´£ | è¾“å…¥ | è¾“å‡º |
|-------|------|------|------|
| **Coordinator** | ä»»åŠ¡åè°ƒï¼Œè¯­è¨€æ£€æµ‹ | ç”¨æˆ·é—®é¢˜ | è·¯ç”±å†³ç­– |
| **BackgroundInvestigator** | é¢„æœç´¢èƒŒæ™¯ä¿¡æ¯ | ç”¨æˆ·é—®é¢˜ | æœç´¢ç»“æœ |
| **Planner** | åˆ¶å®šç ”ç©¶è®¡åˆ’ | ç”¨æˆ·é—®é¢˜ + èƒŒæ™¯ | ç»“æ„åŒ– Plan |
| **Human** | äººå·¥ç¡®è®¤/ä¿®æ”¹è®¡åˆ’ | Plan | ç”¨æˆ·åé¦ˆ |
| **ResearchTeam** | ä»»åŠ¡è°ƒåº¦ï¼Œæ­¥éª¤åˆ†å‘ | Plan | æ­¥éª¤è·¯ç”± |
| **Researcher** | æ·±åº¦ç ”ç©¶ï¼ˆReActï¼‰ | ç ”ç©¶æ­¥éª¤ | ç ”ç©¶ç»“æœ |
| **Coder** | ä»£ç æ‰§è¡Œï¼ˆPython MCPï¼‰ | å¤„ç†æ­¥éª¤ | æ‰§è¡Œç»“æœ |
| **Reporter** | æ±‡æ€»æŠ¥å‘Š | æ‰€æœ‰ç»“æœ | æœ€ç»ˆæŠ¥å‘Š |

##### æ­¥éª¤4ï¼šæ·»åŠ å­å›¾èŠ‚ç‚¹ï¼ˆ88-95è¡Œï¼‰

```go
_ = g.AddGraphNode(consts.Coordinator, coordinatorGraph, compose.WithNodeName(consts.Coordinator))
_ = g.AddGraphNode(consts.Planner, plannerGraph, compose.WithNodeName(consts.Planner))
// ... å…¶ä»–å­å›¾
```

**`AddGraphNode` ç‰¹æ€§**ï¼š
- å°†å­å›¾ä½œä¸ºä¸€ä¸ªæ•´ä½“æ·»åŠ åˆ°ä¸»å›¾
- å­å›¾æœ‰ç‹¬ç«‹çš„å†…éƒ¨èŠ‚ç‚¹ï¼ˆloadã€agentã€routerï¼‰
- å­å›¾ä¸ä¸»å›¾**å…±äº«åŒä¸€ä¸ª State å®ä¾‹**ï¼ˆé€šè¿‡ context ä¼ é€’ï¼‰

##### æ­¥éª¤5ï¼šæ·»åŠ åŠ¨æ€è¾¹ï¼ˆ98-105è¡Œï¼‰

```go
_ = g.AddBranch(consts.Coordinator, compose.NewGraphBranch(agentHandOff, outMap))
_ = g.AddBranch(consts.Planner, compose.NewGraphBranch(agentHandOff, outMap))
// ... å…¶ä»– Agent çš„åŠ¨æ€è¾¹
```

**åŠ¨æ€è¾¹ç‰¹æ€§**ï¼š
- **è¿è¡Œæ—¶è·¯ç”±**ï¼šæ ¹æ® `agentHandOff` çš„è¿”å›å€¼å†³å®šä¸‹ä¸€æ­¥
- **å…¨å±€ç»Ÿä¸€**ï¼šæ‰€æœ‰ Agent éƒ½ä½¿ç”¨åŒä¸€ä¸ªè·¯ç”±å‡½æ•°
- **çŠ¶æ€é©±åŠ¨**ï¼šè·¯ç”±é€»è¾‘å®Œå…¨ä¾èµ– `state.Goto`

##### æ­¥éª¤6ï¼šæ·»åŠ å›ºå®šè¾¹ï¼ˆ108è¡Œï¼‰

```go
_ = g.AddEdge(compose.START, consts.Coordinator)
```

**å”¯ä¸€çš„å›ºå®šè¾¹**ï¼š
- ç¡®ä¿å›¾çš„å…¥å£æ˜¯ Coordinator
- Coordinator è´Ÿè´£åˆå§‹ä»»åŠ¡åˆ†æå’Œè¯­è¨€æ£€æµ‹
- ä¹‹åçš„æ‰€æœ‰æµç¨‹éƒ½é€šè¿‡åŠ¨æ€è·¯ç”±å†³å®š

##### æ­¥éª¤7ï¼šç¼–è¯‘å›¾ï¼ˆ110-114è¡Œï¼‰

```go
r, err := g.Compile(ctx,
    compose.WithGraphName("EinoDeer"),                         // å›¾åç§°
    compose.WithNodeTriggerMode(compose.AnyPredecessor),       // è§¦å‘æ¨¡å¼
    compose.WithCheckPointStore(model.NewDeerCheckPoint(ctx)), // CheckPoint å­˜å‚¨
)
```

**ç¼–è¯‘é€‰é¡¹è§£æ**ï¼š

| é€‰é¡¹ | ä½œç”¨ |
|------|------|
| `WithGraphName` | è®¾ç½®å›¾åç§°ä¸º "EinoDeer"ï¼Œç”¨äºæ—¥å¿—å’Œè°ƒè¯• |
| `WithNodeTriggerMode(AnyPredecessor)` | å…è®¸å¾ªç¯å›¾ï¼šèŠ‚ç‚¹å¯è¢«ä»»æ„å‰é©±è§¦å‘ |
| `WithCheckPointStore` | æ”¯æŒä¸­æ–­å’Œæ¢å¤ï¼šä¿å­˜æ‰§è¡ŒçŠ¶æ€åˆ°å­˜å‚¨ |

**`AnyPredecessor` çš„é‡è¦æ€§**ï¼š
- é»˜è®¤æ¨¡å¼ä¸‹ï¼Œå›¾å¿…é¡»æ˜¯ DAGï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰
- `AnyPredecessor` å…è®¸å¾ªç¯ï¼ˆå¦‚ Planner â†’ Human â†’ Plannerï¼‰
- æ”¯æŒè¿­ä»£å¼çš„è®¡åˆ’-åé¦ˆ-é‡æ–°è§„åˆ’æµç¨‹

---

## ä¸‰ã€å›¾ç»“æ„ä¸è·¯ç”±æœºåˆ¶

### 3.1 å›¾çš„æ‹“æ‰‘ç»“æ„

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚      START      â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ (å›ºå®šè¾¹)
                                 â†“
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”Œâ”€â”€â”€â†’â”‚  Coordinator    â”‚
                   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚             â”‚ (åŠ¨æ€è¾¹: agentHandOff)
                   â”‚             â†“
                   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚    â”‚ Background-     â”‚
                   â”‚    â”‚ Investigator    â”‚â”€â”€â”
                   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                   â”‚                          â”‚ (åŠ¨æ€è¾¹)
                   â”‚                          â†“
                   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚    â”‚    Planner      â”‚â†â”€â”€â”€â”€â”€â”
                   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                   â”‚             â”‚ (åŠ¨æ€è¾¹)      â”‚
                   â”‚             â†“               â”‚
                   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                   â”‚    â”‚     Human       â”‚â”€â”€â”€â”€â”€â”˜
                   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  (EditPlan)
                   â”‚             â”‚ (AcceptPlan)
                   â”‚             â†“
                   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚    â”‚ ResearchTeam    â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                   â”‚             â”‚ (åŠ¨æ€è¾¹)         â”‚
                   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”           â”‚
                   â”‚      â†“             â†“           â”‚
                   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                   â”‚ â”‚Researcherâ”‚ â”‚  Coder   â”‚â”€â”€â”€â”€â”€â”˜
                   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  (è¿”å› ResearchTeam)
                   â”‚      â”‚             â”‚
                   â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                   â”‚             â”‚ (æ‰€æœ‰æ­¥éª¤å®Œæˆ)
                   â”‚             â†“
                   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚    â”‚    Reporter     â”‚
                   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚             â”‚
                   â”‚             â†“
                   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â””â”€â”€â”€â†’â”‚      END        â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 åŠ¨æ€è·¯ç”±çš„å·¥ä½œæµç¨‹

#### è·¯ç”±å†³ç­–é“¾

```
Agent å†…éƒ¨æ‰§è¡Œ:
  â””â”€ router èŠ‚ç‚¹ä¿®æ”¹: state.Goto = "next_agent"

Agent å­å›¾ç»“æŸ:
  â””â”€ è¿”å›åˆ°ä¸»å›¾

ä¸»å›¾çš„ Branch è§¦å‘:
  â””â”€ è°ƒç”¨ agentHandOff(ctx, output)

agentHandOff æ‰§è¡Œ:
  â””â”€ è¯»å–: next = state.Goto
  â””â”€ è¿”å›: "next_agent"

ä¸»å›¾å¼•æ“:
  â””â”€ æ ¹æ®è¿”å›å€¼æ‰¾åˆ°å¯¹åº”å­å›¾
  â””â”€ è§¦å‘ next_agent å­å›¾æ‰§è¡Œ
```

#### çŠ¶æ€ä¼ é€’æœºåˆ¶

```go
// æ‰€æœ‰å­å›¾å…±äº«åŒä¸€ä¸ª State å®ä¾‹ï¼ˆé€šè¿‡ context ä¼ é€’ï¼‰

Coordinator.router:
  compose.ProcessState[*model.State](ctx, func(_, state *model.State) {
      state.Goto = consts.Planner  // ä¿®æ”¹å…±äº«çŠ¶æ€
  })

agentHandOff:
  compose.ProcessState[*model.State](ctx, func(_, state *model.State) {
      next = state.Goto  // è¯»å–åŒä¸€ä¸ªçŠ¶æ€å®ä¾‹
  })
```

**å…³é”®ç‚¹**ï¼š
- State é€šè¿‡ `context.Context` éšå¼ä¼ é€’
- `ProcessState` ç¡®ä¿å¹¶å‘å®‰å…¨çš„çŠ¶æ€è®¿é—®
- æ‰€æœ‰ Agent è¯»å†™çš„æ˜¯**åŒä¸€ä¸ª State å®ä¾‹**

---

## å››ã€å®Œæ•´æ‰§è¡Œæµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šç”¨æˆ·æé—® "What are the latest AI trends in 2025?"

```
1ï¸âƒ£ START â†’ Coordinator
   â”œâ”€ load: åŠ è½½ System Prompt
   â”œâ”€ agent: LLM åˆ†æä»»åŠ¡ï¼Œè°ƒç”¨ hand_to_planner tool
   â”‚         Arguments: {"task_title": "AI trends 2025", "locale": "en-US"}
   â””â”€ router: state.Goto = "background_investigator"
              state.Locale = "en-US"

2ï¸âƒ£ agentHandOff â†’ BackgroundInvestigator
   â”œâ”€ search: ä½¿ç”¨ Brave Search æœç´¢ "latest AI trends 2025"
   â”‚          state.BackgroundInvestigationResults = "AI trends summary..."
   â””â”€ router: state.Goto = "planner"

3ï¸âƒ£ agentHandOff â†’ Planner
   â”œâ”€ load: Prompt åŒ…å«èƒŒæ™¯è°ƒæŸ¥ç»“æœ
   â”œâ”€ agent: LLM ç”Ÿæˆ Plan
   â”‚         {
   â”‚           "has_enough_context": true,
   â”‚           "steps": [
   â”‚             {"title": "Research multimodal AI", "step_type": "research"},
   â”‚             {"title": "Analyze adoption trends", "step_type": "research"},
   â”‚             {"title": "Generate charts", "step_type": "processing"}
   â”‚           ]
   â”‚         }
   â””â”€ router: state.CurrentPlan = {...}
              state.Goto = "reporter"  // has_enough_context = true

4ï¸âƒ£ agentHandOff â†’ Reporter (ç›´æ¥è·³è¿‡ ResearchTeamï¼Œå› ä¸º has_enough_context = true)
   â”œâ”€ load: æ”¶é›†æ‰€æœ‰æ­¥éª¤ç»“æœ
   â”œâ”€ agent: LLM ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
   â””â”€ router: state.Goto = compose.END

5ï¸âƒ£ agentHandOff â†’ END
   â””â”€ å›¾æ‰§è¡Œç»“æŸï¼Œè¿”å›æœ€ç»ˆæŠ¥å‘Š
```

### å¤æ‚åœºæ™¯ï¼šéœ€è¦è¿­ä»£å’Œäººå·¥ç¡®è®¤

```
1ï¸âƒ£ Coordinator â†’ Planner

2ï¸âƒ£ Planner:
   â”œâ”€ has_enough_context = false
   â””â”€ state.Goto = "human_feedback"

3ï¸âƒ£ Human:
   â”œâ”€ AutoAcceptedPlan = false
   â”œâ”€ ä¸­æ–­ç­‰å¾…ç”¨æˆ·è¾“å…¥
   â””â”€ ç”¨æˆ·é€‰æ‹©: InterruptFeedback = "edit_plan"
      state.Goto = "planner"

4ï¸âƒ£ Planner (ç¬¬äºŒæ¬¡):
   â”œâ”€ æ ¹æ®åé¦ˆé‡æ–°åˆ¶å®šè®¡åˆ’
   â”œâ”€ has_enough_context = true
   â””â”€ state.Goto = "research_team"

5ï¸âƒ£ ResearchTeam:
   â””â”€ åˆ†å‘æ­¥éª¤åˆ° Researcher å’Œ Coder

6ï¸âƒ£ Researcher â†’ ResearchTeam (å¾ªç¯)
   â””â”€ å®Œæˆæ‰€æœ‰ research æ­¥éª¤

7ï¸âƒ£ Coder â†’ ResearchTeam (å¾ªç¯)
   â””â”€ å®Œæˆæ‰€æœ‰ processing æ­¥éª¤

8ï¸âƒ£ ResearchTeam:
   â”œâ”€ æ‰€æœ‰æ­¥éª¤å®Œæˆ
   â””â”€ state.Goto = "reporter"

9ï¸âƒ£ Reporter â†’ END
```

---

## äº”ã€è®¾è®¡æ¨¡å¼ä¸æ¶æ„ç‰¹ç‚¹

### 5.1 ä¸­å¿ƒåŒ–è·¯ç”±æ¨¡å¼ï¼ˆHub-and-Spokeï¼‰

**ç‰¹ç‚¹**ï¼š
- æ‰€æœ‰ Agent é€šè¿‡ç»Ÿä¸€çš„ `agentHandOff` å‡½æ•°è·¯ç”±
- çŠ¶æ€é©±åŠ¨ï¼ˆ`state.Goto`ï¼‰è€Œéç¡¬ç¼–ç é€»è¾‘
- æ˜“äºæ‰©å±•ï¼šæ–°å¢ Agent åªéœ€æ·»åŠ åˆ° `outMap` å¹¶åˆ›å»ºå­å›¾

**ä¼˜åŠ¿**ï¼š
- âœ… **ç»Ÿä¸€ç®¡ç†**ï¼šè·¯ç”±é€»è¾‘é›†ä¸­ï¼Œæ˜“äºè°ƒè¯•
- âœ… **çµæ´»è·¯ç”±**ï¼šæ”¯æŒä»»æ„ Agent é—´çš„è·³è½¬
- âœ… **æ—¥å¿—è¿½è¸ª**ï¼šæ‰€æœ‰è·¯ç”±éƒ½ç»è¿‡ `agentHandOff`ï¼Œä¾¿äºç›‘æ§

### 5.2 å­å›¾æ¨¡å¼ï¼ˆSubgraph Patternï¼‰

**ç‰¹ç‚¹**ï¼š
- æ¯ä¸ª Agent éƒ½æ˜¯ç‹¬ç«‹çš„å­å›¾ï¼ˆload â†’ agent â†’ routerï¼‰
- å­å›¾å†…éƒ¨é€»è¾‘å°è£…ï¼Œå¯¹å¤–æä¾›ç»Ÿä¸€æ¥å£
- å­å›¾å…±äº«å…¨å±€ Stateï¼Œä½†æœ‰ç‹¬ç«‹çš„å†…éƒ¨èŠ‚ç‚¹

**ä¼˜åŠ¿**ï¼š
- âœ… **èŒè´£åˆ†ç¦»**ï¼šæ¯ä¸ª Agent ä¸“æ³¨äºç‰¹å®šä»»åŠ¡
- âœ… **æ˜“äºæµ‹è¯•**ï¼šå­å›¾å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- âœ… **ä»£ç å¤ç”¨**ï¼šç»Ÿä¸€çš„ä¸‰èŠ‚ç‚¹ç»“æ„ï¼ˆloadã€agentã€routerï¼‰

### 5.3 çŠ¶æ€å…±äº«æ¨¡å¼ï¼ˆShared State Patternï¼‰

**å®ç°**ï¼š

```go
// ä¸»å›¾åˆ›å»ºæ—¶æ³¨å…¥çŠ¶æ€ç”Ÿæˆå‡½æ•°
g := compose.NewGraph[I, O](
    compose.WithGenLocalState(genFunc),
)

// æ¯ä¸ª Agent é€šè¿‡ ProcessState è®¿é—®çŠ¶æ€
compose.ProcessState[*model.State](ctx, func(_, state *model.State) error {
    state.Goto = "next_agent"  // æ‰€æœ‰ Agent æ“ä½œåŒä¸€ä¸ªå®ä¾‹
    return nil
})
```

**ä¼˜åŠ¿**ï¼š
- âœ… **å¹¶å‘å®‰å…¨**ï¼š`ProcessState` å†…éƒ¨ä½¿ç”¨é”ä¿æŠ¤
- âœ… **éšå¼ä¼ é€’**ï¼šé€šè¿‡ context ä¼ é€’ï¼Œæ— éœ€æ˜¾å¼å‚æ•°
- âœ… **çŠ¶æ€ä¸€è‡´**ï¼šæ‰€æœ‰ Agent çœ‹åˆ°ç›¸åŒçš„çŠ¶æ€

### 5.4 å¾ªç¯å›¾æ¨¡å¼ï¼ˆCyclic Graph Patternï¼‰

**å…³é”®é…ç½®**ï¼š

```go
compose.WithNodeTriggerMode(compose.AnyPredecessor)
```

**æ”¯æŒçš„å¾ªç¯**ï¼š
1. **Planner â†’ Human â†’ Planner**ï¼ˆè®¡åˆ’ä¿®æ”¹ï¼‰
2. **ResearchTeam â†’ Researcher â†’ ResearchTeam**ï¼ˆè¿­ä»£ç ”ç©¶ï¼‰
3. **ResearchTeam â†’ Coder â†’ ResearchTeam**ï¼ˆè¿­ä»£å¤„ç†ï¼‰

**å¾ªç¯ç»ˆæ­¢æ¡ä»¶**ï¼š
- Planner: `has_enough_context = true` æˆ– `PlanIterations` è¾¾åˆ°ä¸Šé™
- ResearchTeam: æ‰€æœ‰ `ExecutionRes != nil` æˆ– `MaxPlanIterations` è¾¾åˆ°ä¸Šé™

---

## å…­ã€CheckPoint æœºåˆ¶

### 6.1 ä¸­æ–­ä¸æ¢å¤

```go
compose.WithCheckPointStore(model.NewDeerCheckPoint(ctx))
```

**æ”¯æŒçš„æ“ä½œ**ï¼š
1. **ä¿å­˜çŠ¶æ€**ï¼šåœ¨ Human èŠ‚ç‚¹ä¸­æ–­æ—¶ä¿å­˜
2. **æ¢å¤æ‰§è¡Œ**ï¼šä»ä¸­æ–­ç‚¹ç»§ç»­æ‰§è¡Œ
3. **çŠ¶æ€æŒä¹…åŒ–**ï¼šæ”¯æŒè·¨è¿›ç¨‹/è·¨ä¼šè¯æ¢å¤

### 6.2 ä¸­æ–­ç‚¹

å½“å‰ç³»ç»Ÿä¸­çš„ä¸­æ–­ç‚¹ï¼š

```go
// human_feedback.go
if !state.AutoAcceptedPlan {
    switch state.InterruptFeedback {
    case consts.AcceptPlan, consts.EditPlan:
        // ç»§ç»­æ‰§è¡Œ
    default:
        return compose.InterruptAndRerun  // ğŸ‘ˆ ä¸­æ–­ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥
    }
}
```

**æ¢å¤æµç¨‹**ï¼š
1. ç”¨æˆ·è®¾ç½® `state.InterruptFeedback`
2. è°ƒç”¨ `Runnable.Generate()` å¹¶ä¼ å…¥ CheckPointID
3. ä»ä¿å­˜çš„çŠ¶æ€æ¢å¤ï¼Œç»§ç»­æ‰§è¡Œ

---

## ä¸ƒã€æ³›å‹è®¾è®¡åˆ†æ

### 7.1 æ³›å‹å‚æ•°çš„ä½¿ç”¨

```go
func Builder[I, O, S any](ctx context.Context, genFunc compose.GenLocalState[S]) compose.Runnable[I, O]

coordinatorGraph := NewCAgent[I, O](ctx)  // æ‰€æœ‰å­å›¾ä½¿ç”¨ç›¸åŒçš„æ³›å‹å‚æ•°
```

### 7.2 å®é™…ç±»å‹

è™½ç„¶å£°æ˜äº†æ³›å‹ï¼Œä½†å®é™…ä½¿ç”¨ä¸­ï¼š
- `I` é€šå¸¸æ˜¯ `string` æˆ– `[]*schema.Message`
- `O` é€šå¸¸æ˜¯ `string` æˆ– `*schema.Message`
- `S` å›ºå®šä¸º `*model.State`

### 7.3 è®¾è®¡é—®é¢˜ï¼ˆæ³¨é‡Šä¸­æåˆ°ï¼‰

```go
// 78è¡Œæ³¨é‡Šï¼šæ•´ä¸ªæ–¹æ³•æ ‡äº†èŒƒæ€§ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªnodeçš„å®ç°ç¡®æ˜¯å†™æ­»çš„ç±»å‹ï¼Œ
// æ„Ÿè§‰ä¸æ ‡èŒƒå§“ï¼Œç›´æ¥å®šå¥½æ›´æ˜“è¯»ä¸€äº›
```

**é—®é¢˜**ï¼š
- å­å›¾å†…éƒ¨èŠ‚ç‚¹ä½¿ç”¨çš„æ˜¯å›ºå®šç±»å‹ï¼ˆå¦‚ `string`ã€`*schema.Message`ï¼‰
- æ³›å‹å‚æ•° `I, O` åœ¨å†…éƒ¨å¹¶æœªçœŸæ­£ä½¿ç”¨
- åªæ˜¯ä¸ºäº†æ»¡è¶³ `Graph[I, O]` çš„æ¥å£è¦æ±‚

**å¯èƒ½çš„æ”¹è¿›**ï¼š
```go
// æ›´ç›´æ¥çš„æ–¹å¼
func Builder(ctx context.Context) compose.Runnable[string, string]
```

---

## å…«ã€æ€§èƒ½ä¸å¯æ‰©å±•æ€§

### 8.1 æ€§èƒ½è€ƒè™‘

**æ½œåœ¨ç“¶é¢ˆ**ï¼š
1. **çŠ¶æ€é”ç«äº‰**ï¼šæ‰€æœ‰ Agent é€šè¿‡ `ProcessState` è®¿é—®çŠ¶æ€
2. **å­å›¾å¼€é”€**ï¼šæ¯ä¸ª Agent éƒ½æ˜¯å®Œæ•´çš„å­å›¾ï¼ˆ3 ä¸ªèŠ‚ç‚¹ï¼‰
3. **MCP å·¥å…·åŠ è½½**ï¼šæ³¨é‡Šæ‰çš„å·¥å…·åŠ è½½é€»è¾‘ï¼ˆ48-60è¡Œï¼‰

**ä¼˜åŒ–å»ºè®®**ï¼š
- ä½¿ç”¨è¯»å†™é”ä¼˜åŒ–çŠ¶æ€è®¿é—®
- è€ƒè™‘å°†ç®€å• Agent ç®€åŒ–ä¸ºå•èŠ‚ç‚¹
- å»¶è¿ŸåŠ è½½ MCP å·¥å…·ï¼ˆæŒ‰éœ€åŠ è½½ï¼‰

### 8.2 å¯æ‰©å±•æ€§

**æ–°å¢ Agent çš„æ­¥éª¤**ï¼š

```go
// 1. åˆ›å»ºå­å›¾æ„é€ å‡½æ•°
func NewMyAgent[I, O any](ctx context.Context) *compose.Graph[I, O] { ... }

// 2. åœ¨ outMap ä¸­æ·»åŠ 
outMap := map[string]bool{
    // ... ç°æœ‰ Agent
    consts.MyAgent: true,
}

// 3. åˆå§‹åŒ–å­å›¾
myAgentGraph := NewMyAgent[I, O](ctx)

// 4. æ·»åŠ åˆ°ä¸»å›¾
_ = g.AddGraphNode(consts.MyAgent, myAgentGraph, compose.WithNodeName(consts.MyAgent))

// 5. æ·»åŠ åŠ¨æ€è¾¹
_ = g.AddBranch(consts.MyAgent, compose.NewGraphBranch(agentHandOff, outMap))
```

**æ— éœ€ä¿®æ”¹**ï¼š
- `agentHandOff` å‡½æ•°ï¼ˆé€šç”¨è·¯ç”±é€»è¾‘ï¼‰
- å…¶ä»– Agent çš„ä»£ç ï¼ˆå®Œå…¨è§£è€¦ï¼‰

---

## ä¹ã€æ€»ç»“

### æ ¸å¿ƒä»·å€¼

Builder å®ç°äº†ä¸€ä¸ª**é«˜åº¦çµæ´»ã€å¯æ‰©å±•çš„å¤šæ™ºèƒ½ä½“åä½œæ¡†æ¶**ï¼š

1. **ç»Ÿä¸€è·¯ç”±æœºåˆ¶**ï¼šé€šè¿‡ `agentHandOff` + `state.Goto` å®ç°åŠ¨æ€æµç¨‹æ§åˆ¶
2. **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ª Agent ç‹¬ç«‹å°è£…ï¼ŒèŒè´£æ˜ç¡®
3. **çŠ¶æ€å…±äº«**ï¼šæ‰€æœ‰ Agent å…±äº«å…¨å±€çŠ¶æ€ï¼Œç¡®ä¿ä¿¡æ¯ä¸€è‡´æ€§
4. **æ”¯æŒå¾ªç¯**ï¼šé€šè¿‡ `AnyPredecessor` æ”¯æŒè¿­ä»£å¼å·¥ä½œæµ
5. **ä¸­æ–­æ¢å¤**ï¼šé€šè¿‡ CheckPoint æ”¯æŒäººå·¥ä»‹å…¥å’ŒçŠ¶æ€æŒä¹…åŒ–

### è®¾è®¡äº®ç‚¹

- âœ… **ä¸­å¿ƒåŒ–è·¯ç”±**ï¼šæ‰€æœ‰è·¯ç”±é€»è¾‘é›†ä¸­ç®¡ç†ï¼Œæ˜“äºè°ƒè¯•å’Œç›‘æ§
- âœ… **çŠ¶æ€é©±åŠ¨**ï¼šé¿å…ç¡¬ç¼–ç è·¯ç”±é€»è¾‘ï¼Œçµæ´»æ€§æé«˜
- âœ… **å­å›¾æ¨¡å¼**ï¼šæ¯ä¸ª Agent ç‹¬ç«‹æµ‹è¯•å’Œå¼€å‘
- âœ… **å¾ªç¯æ”¯æŒ**ï¼šæ”¯æŒè®¡åˆ’-åé¦ˆ-é‡è§„åˆ’ç­‰å¤æ‚æµç¨‹
- âœ… **å¯æ‰©å±•**ï¼šæ–°å¢ Agent æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 

### æ¶æ„å›¾

```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚         Builder (ä¸»æ„å»ºå™¨)           â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   åˆ›å»ºä¸»å›¾ + æ³¨å…¥çŠ¶æ€      â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚                       â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ åˆå§‹åŒ–  â”‚             â”‚  æ·»åŠ      â”‚             â”‚  ç¼–è¯‘   â”‚
    â”‚ 8ä¸ªå­å›¾  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ èŠ‚ç‚¹+è¾¹   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  æˆå›¾   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                       â”‚                       â”‚
        â”‚                       â”‚                       â”‚
    [Coordinator]         [åŠ¨æ€è¾¹: agentHandOff]    [Runnable]
    [Planner]            [å›ºå®šè¾¹: STARTâ†’Coordinator]
    [Reporter]            [CheckPointæ”¯æŒ]
    [ResearchTeam]
    [Researcher]
    [Coder]
    [BackgroundInv.]
    [Human]
```

è¿™æ˜¯ä¸€ä¸ª**ç”Ÿäº§çº§çš„å¤šæ™ºèƒ½ä½“ç¼–æ’æ¡†æ¶**ï¼Œä½“ç°äº†ç°ä»£ AI Agent ç³»ç»Ÿè®¾è®¡çš„æœ€ä½³å®è·µï¼

